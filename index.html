<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gmail OTP Grabber (PWA)</title>
  <meta name="theme-color" content="#3367d6"/>
  <link rel="manifest" href="manifest.json">
  <style>
    body{font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue",Roboto,Segoe UI,sans-serif; padding:18px; max-width:700px; margin:auto;}
    button{display:inline-block;margin:8px 0;padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#f6f6f6;}
    #otp{font-size:1.6rem; margin-top:12px; padding:6px 10px; border:1px dashed #999; display:inline-block; min-width:160px; text-align:center;}
    small {color:#666;}
  </style>
</head>
<body>
  <h2>Gmail OTP 取得（自分用）</h2>
  <p><small>説明：Google にログインし、受信メールの2文目にある6桁コードを抽出してクリップボードにコピーします。</small></p>

  <div>
    <button id="signin">Google に接続</button>
    <button id="signout" style="display:none">サインアウト</button>
  </div>

  <div>
    <button id="fetch" disabled>最新の OTP を探す</button>
    <button id="copy" disabled>クリップボードにコピー</button>
  </div>

  <div style="margin-top:16px;">
    <div id="otp">—</div>
    <div><small id="status"></small></div>
  </div>

  <!-- gapi -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    // ====== 設定 ======
    const CLIENT_ID = '349241478693-q833fmg76ghb4s1vdni9j91rmfhednno.apps.googleusercontent.com'; // ← ここを書き換えて
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    // ====== UI ======
    const signinBtn = document.getElementById('signin');
    const signoutBtn = document.getElementById('signout');
    const fetchBtn = document.getElementById('fetch');
    const copyBtn = document.getElementById('copy');
    const otpEl = document.getElementById('otp');
    const statusEl = document.getElementById('status');

    let googleAuthInstance = null;
    let lastOtp = null;

    function setStatus(s){ statusEl.textContent = s || ''; }

    // ====== gapi 初期化 ======
    function initClient() {
      gapi.load('client:auth2', async () => {
        try {
          await gapi.client.init({
            clientId: CLIENT_ID,
            scope: SCOPES,
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"]
          });
          googleAuthInstance = gapi.auth2.getAuthInstance();
          updateSigninStatus(googleAuthInstance.isSignedIn.get());
          googleAuthInstance.isSignedIn.listen(updateSigninStatus);
        } catch (e) {
          console.error(e);
          setStatus('gapi 初期化に失敗しました: ' + e.message);
        }
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        signinBtn.style.display = 'none';
        signoutBtn.style.display = '';
        fetchBtn.disabled = false;
        setStatus('Google に接続済み');
      } else {
        signinBtn.style.display = '';
        signoutBtn.style.display = 'none';
        fetchBtn.disabled = true;
        setStatus('未接続');
      }
    }

    signinBtn.onclick = () => googleAuthInstance.signIn();
    signoutBtn.onclick = () => googleAuthInstance.signOut();

    // ====== OTP 検索ロジック（2文目の6桁数字を抽出） ======
    async function findLatestOtp() {
      setStatus('検索中…');
      otpEl.textContent = '—';
      lastOtp = null;

      try {
        const q = encodeURIComponent('newer_than:1d ワンタイムパスワード');
        const listResp = await gapi.client.gmail.users.messages.list({
          userId: 'me',
          q: decodeURIComponent(q),
          maxResults: 5
        });

        const msgs = listResp.result.messages || [];
        if (msgs.length === 0) {
          setStatus('該当メールが見つかりません');
          return null;
        }

        // 最新のメールを取得
        const mResp = await gapi.client.gmail.users.messages.get({
          userId: 'me',
          id: msgs[0].id,
          format: 'full'
        });

        const body = extractPlainTextFromMessage(mResp.result);
        if (!body) {
          setStatus('本文が見つかりません');
          return null;
        }

        // ← 修正ポイント：本文の2文目から6桁数字を探す
        const otp = extractSixDigitFromSecondSentence(body);

        if (otp) {
          lastOtp = otp;
          otpEl.textContent = otp;
          copyBtn.disabled = false;
          setStatus('OTP を検出しました');
          return otp;
        } else {
          setStatus('2文目に6桁の数字が見つかりませんでした');
          return null;
        }

      } catch (e) {
        console.error(e);
        setStatus('エラー: ' + (e.message || e.result || e));
        return null;
      }
    }

    // ====== メッセージ本文抽出 ======
    function extractPlainTextFromMessage(msg) {
      if (!msg || !msg.payload) return '';
      function decodeBase64Url(str) {
        if (!str) return '';
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        try {
          return decodeURIComponent(escape(atob(str)));
        } catch {
          try { return atob(str); } catch { return ''; }
        }
      }

      if (msg.payload.body && msg.payload.body.data)
        return decodeBase64Url(msg.payload.body.data);

      if (msg.payload.parts && msg.payload.parts.length) {
        for (const p of msg.payload.parts) {
          if (p.mimeType === 'text/plain' && p.body && p.body.data)
            return decodeBase64Url(p.body.data);
          if (p.parts && p.parts.length) {
            for (const sub of p.parts) {
              if (sub.mimeType === 'text/plain' && sub.body && sub.body.data)
                return decodeBase64Url(sub.body.data);
            }
          }
        }
      }
      return '';
    }

    // ====== 2文目の6桁数字を抽出 ======
    function extractSixDigitFromSecondSentence(text) {
      if (!text) return null;
      // 文ごとに分割（句点 or 改行）
      const sentences = text.split(/[\n。]/).map(s => s.trim()).filter(Boolean);
      if (sentences.length < 2) return null;
      const match = sentences[1].match(/\b\d{6}\b/);
      return match ? match[0] : null;
    }

    // ====== クリップボードコピー ======
    async function copyToClipboard(text) {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus('クリップボードにコピーしました');
      } catch (e) {
        setStatus('コピーできません（権限を確認）');
      }
    }

    // ====== ボタンイベント ======
    fetchBtn.onclick = async () => {
      fetchBtn.disabled = true;
      await findLatestOtp();
      fetchBtn.disabled = false;
    };
    copyBtn.onclick = async () => {
      if (!lastOtp) return setStatus('コピーする OTP がありません');
      await copyToClipboard(lastOtp);
    };

    // ====== 初期化 ======
    window.addEventListener('load', initClient);
  </script>
</body>
</html>
